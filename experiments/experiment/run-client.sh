#!/bin/bash
exec >> ~/log.txt
exec 2>&1

IP=`ifconfig enp8s0d1 | grep "inet " | awk  '{print $2}'| awk '{print $1}'`

if [ "$IP" = "" ]; then
  IP=`ifconfig enp4s0 | grep "inet " | awk  '{print $2}'| awk '{print $1}'`
fi

if [ "$IP" = "" ]; then
  IP=`ifconfig em1 | grep "inet " | awk  '{print $2}'| awk '{print $1}'`
fi

if [ "$IP" = "" ]; then
  IP=`ifconfig ens1f1 | grep "inet " | awk  '{print $2}'| awk '{print $1}'`
fi

if [ "$IP" = "" ]; then
  echo "No IP found, exiting!" 1>&2
  exit 1
fi

echo "Using IP '$IP'"

G_ID=`cat zones.txt | grep $IP |cut -f 5`

LOCALGROUPS="-lcs "
GLOBALGROUPS=""
for i in `ls -d group*`; do
  if [ "${i:0:7}" != "group-g" ]; then
    LOCALGROUPS=$LOCALGROUPS"$i "
  else
    GLOBALGROUPS=$GLOBALGROUPS"$i "
  fi
done

if [ "$GLOBALGROUPS" = "" ]; then
  echo "Single group configuration"
  G_ID=0
  GLOBALGROUPS="${LOCALGROUPS:5}"
  LOCALGROUPS=""
fi

if [ "$G_ID" = "" ]; then
  echo "Group id mismatch, exiting!"
  exit
fi

echo "Running $QTY clients in group $G_ID..."
java -Xmx32G -cp '../../target/*:../../lib/*' ch.usi.inf.dslab.bftamcast.client.Client -i $RANDOM -g $G_ID -gc $GLOBALGROUPS $LOCALGROUPS -c 1000 -p 100 $@ 
